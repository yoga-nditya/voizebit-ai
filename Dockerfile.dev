FROM python:3.11-slim-bookworm

ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /app

# Fix apt configuration dan ganti ke HTTPS
RUN echo "Acquire::http::Pipeline-Depth 0;" > /etc/apt/apt.conf.d/99custom \
    && echo "Acquire::http::No-Cache true;" >> /etc/apt/apt.conf.d/99custom \
    && echo "Acquire::BrokenProxy true;" >> /etc/apt/apt.conf.d/99custom \
    && echo "Acquire::Check-Valid-Until false;" >> /etc/apt/apt.conf.d/99custom \
    && echo "Acquire::Retries 3;" >> /etc/apt/apt.conf.d/99custom

# Ganti semua repository ke HTTPS (untuk Debian Bookworm format baru)
RUN find /etc/apt/sources.list.d/ -type f -name "*.sources" -exec sed -i 's|http://deb.debian.org|https://deb.debian.org|g' {} + || true \
    && find /etc/apt/sources.list.d/ -type f -name "*.sources" -exec sed -i 's|http://security.debian.org|https://security.debian.org|g' {} + || true \
    && if [ -f /etc/apt/sources.list ]; then \
         sed -i 's|http://deb.debian.org|https://deb.debian.org|g' /etc/apt/sources.list; \
         sed -i 's|http://security.debian.org|https://security.debian.org|g' /etc/apt/sources.list; \
       fi

# Update dan install packages
RUN apt-get update && apt-get install -y --no-install-recommends \
      ca-certificates \
      libreoffice-writer \
      libreoffice-calc \
      libreoffice-java-common \
      poppler-utils \
      unzip \
      zip \
      fontconfig \
      fonts-dejavu-core \
      build-essential \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt /app/requirements.txt
RUN pip install --upgrade pip && pip install --no-cache-dir -r /app/requirements.txt

# Copy application files
COPY . /app

# Create necessary directories
RUN mkdir -p /app/static/files /app/temp

# Set environment variables
ENV PORT=5000

# Expose port
EXPOSE 5000

# Run application
CMD ["python3", "app.py"]